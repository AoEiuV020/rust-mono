# Rust 多模块项目结构说明

## 项目概述

这是一个 Rust 多模块单体仓库（Monorepo）项目，演示了静态链接和动态链接两种不同的应用构建方式。项目包含三个库模块和两个应用模块。

## 项目结构

```
rust-mono/
├── Cargo.toml         # Workspace 配置
├── packages/          # 库模块目录
│   ├── common/       # 通用库
│   ├── mathlib/      # 数学功能库
│   └── stringlib/    # 字符串功能库
├── apps/             # 应用模块目录
│   ├── static-app/   # 静态链接应用
│   └── dynamic-app/  # 动态链接应用
├── scripts/          # 构建脚本目录
├── md/               # 文档目录
└── build/            # 编译输出目录（由构建脚本生成）
```

## 模块说明

### 1. Common 通用库

**位置**: `packages/common`

**功能描述**:
- 提供项目中其他模块共用的基础功能
- 包含日志记录器，用于输出带时间戳和前缀的日志信息
- 提供基础工具函数，如字符串大写转换、整数比较等

**主要组件**:
- **Logger**: 日志记录器，支持格式化输出
- **工具函数**: 包括字符串转大写、求最大值、求最小值等

**依赖**: 
- chrono（时间处理）
- 标准库

**库类型**: `rlib`（静态库）+ `cdylib`（动态库）

### 2. MathLib 数学功能库

**位置**: `packages/mathlib`

**功能描述**:
- 提供数学计算相关功能
- 所有计算操作都会通过日志记录器记录执行过程

**主要组件**:
- **Calculator**: 计算器结构体，提供以下功能
  - 加法运算
  - 乘法运算
  - 阶乘计算
  - 三个数求最大值（使用 common 库的 max 函数）

**依赖**: 
- common 库（用于日志记录和工具函数）
- 标准库

**库类型**: `rlib`（静态库）+ `cdylib`（动态库）

### 3. StringLib 字符串功能库

**位置**: `packages/stringlib`

**功能描述**:
- 提供字符串处理相关功能
- 所有处理操作都会通过日志记录器记录执行过程

**主要组件**:
- **StringProcessor**: 字符串处理器，提供以下功能
  - 字符串反转
  - 多个字符串连接（可指定分隔符）
  - 字符串转大写（使用 common 库的函数）
  - 统计字符串中的单词数量

**依赖**:
- common 库（用于日志记录和工具函数）
- 标准库

**库类型**: `rlib`（静态库）+ `cdylib`（动态库）

### 4. Static-App 静态链接应用

**位置**: `apps/static-app`

**功能描述**:
- 演示应用，使用静态链接方式编译
- 调用三个库的所有主要功能并输出结果

**构建方式**: 
- 所有依赖库的代码会被完全编译到最终的可执行文件中
- 生成单个独立的可执行文件，不需要额外的动态库文件

**依赖**:
- common 库
- mathlib 库
- stringlib 库
- 标准库

### 5. Dynamic-App 动态链接应用

**位置**: `apps/dynamic-app`

**功能描述**:
- 演示应用，使用动态链接方式编译
- 功能与 static-app 完全相同，用于对比两种链接方式的差异

**构建方式**:
- 依赖库会先编译成共享库文件（.dylib 或 .so）
- 应用本身编译为可执行文件，运行时使用 libloading 动态加载共享库
- 需要共享库文件与可执行文件在正确的路径下

**依赖**:
- libloading（动态库加载）
- libc（C FFI 支持）
- 标准库

## 应用功能说明

两个应用执行相同的操作序列：

### 数学运算
1. 执行加法：10 + 20
2. 执行乘法：5 × 7
3. 计算阶乘：5!
4. 求三个数的最大值：Max(15, 8, 23)

### 字符串处理
1. 反转字符串："Hello World"
2. 连接字符串：使用 " - " 连接 "Rust", "Mono", "Project"
3. 转换为大写："rustlang" → "RUSTLANG"
4. 统计单词数："This is a test string"

### 输出
- 详细的日志信息（包括时间戳和模块标识）
- 计算结果摘要表

## 静态链接 vs 动态链接

### 静态链接
- **优点**: 生成单一可执行文件，部署简单，不依赖外部库文件，性能最优
- **缺点**: 文件体积较大（但在 Rust 中优化得很好），多个应用重复包含相同库代码

### 动态链接
- **优点**: 多个应用可共享库文件（当有多个应用时才有优势）
- **缺点**: 总体积更大，需要管理共享库文件，运行时加载开销，部署复杂

## C 兼容层设计

每个库都包含 C 兼容的导出函数，用于动态库调用：

1. **对象管理**: 使用 ID 映射管理 Rust 对象，避免直接传递 Rust 指针
2. **字符串处理**: 使用 C 字符串（`*const c_char`）进行跨 FFI 边界传递
3. **内存管理**: 提供相应的 free 函数释放分配的资源
4. **类型转换**: C 兼容层仅负责类型转换，实际逻辑调用原始 Rust 代码

## 构建说明

项目提供了自动化构建脚本，位于 `scripts/build.sh`，该脚本会：
1. 清理之前的构建产物
2. 创建必要的输出目录
3. 编译静态链接版本的应用
4. 编译动态链接版本的共享库和应用
5. 设置正确的运行时库路径（macOS 使用 `@executable_path/lib`）

详细的构建过程和大小对比结果请参见构建测试总结文档。
